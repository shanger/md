# DNS 解析过程
## 前言
本篇作为“[从浏览器输入URL拓展开](https://www.ilmiao.com/article/js/18)”系列的第一篇，完整知识体系可以将上述文章作为目录查看。
## DNS
> 网络通讯大部分是基于TCP/IP的，而TCP/IP是基于IP地址的，所以计算机在网络上进行通讯时只能识别如“202.96.134.133”之类的IP地址，而不能认识域名 -- [DNS原理及其解析过程【精彩剖析】](https://blog.51cto.com/369369/812889)

由于上述原因，域名系统应运而生，将域名和ip地址相互映射，方便用户访问相关服务，便于记忆。我们讨论问题的起点是从输入URL开始，那下面就看看过程中都经历了什么？（以浏览器为例）
## 解析过程
### 1. 访问浏览器缓存
当用户已经访问过某个域名，浏览器就会在自己的缓存中查找是否有该域名对应的IP，如果有则完成域名解析。
### 2. 系统缓存
如果浏览器缓存未命中，则开始检查本机host文件(修改host可以做很多有意思的事，比如局域网里仿冒DNS、加快域名解析、翻墙)DNS缓存是否有该域名的访问记录，如果有则完成域名解析。
### 3. 路由器缓存
当前两种缓存均未命中的情况下，客户端DNS缓存还有一招就是在路由器也会缓存域名的访问记录。
### 4. ISP（互联网服务提供商）DNS缓存
当在客户端DNS缓存查找不到域名对应IP地址，则将进入ISP DNS缓存中进行查询。
### 5. 根域名服务器、顶级域名服务器、主域名服务器
如果本地DNS服务器本地区域文件与缓存解析都失效，则根据本地DNS服务器的设置（是否设置转发器）进行查询

## 请求过程
![dns请求](http://img.ilmiao.com/3e6779ad62792.png)
![dns请求返回内容](http://img.ilmiao.com/4291d0ca216dc.png)


#### 未用转发模式
本地DNS把请求发至13台根DNS，根DNS服务器收到请求后会判断这个域名(.com)是谁来授权管理，并会返回一个负责该顶级域名服务器的一个IP。本地DNS服务器收到IP信息后，将会联系负责.com域的这台服务器。这台负责.com域的服务器收到请求后，如果自己无法解析，它就会找一个管理.com域的下一级DNS服务器地址(http://qq.com)给本地DNS服务器。当本地DNS服务器收到这个地址后，就会找http://qq.com域服务器，重复上面的动作，进行查询，直至找到www.qq.com主机
#### 转发模式
此DNS服务器就会把请求转发至上一级DNS服务器，由上一级服务器进行解析，上一级服务器如果不能解析，或找根DNS或把转请求转至上上级，以此循环。不管是本地DNS服务器用是是转发，还是根提示，最后都是把结果返回给本地DNS服务器，由此DNS服务器再返回给客户机
## 知识点&&拓展
* 根域名服务器只有13台？

这部分有兴趣的可以去了解下，这边提供传送门 [为什么域名根服务器只能有13台呢？](https://www.zhihu.com/question/22587247/answer/66417484)
* DNS解析的TTL参数

TTL(Time To Live) 用来设置本地DNS服务器域名缓存的最长时间。举例：阿里云解析默认的TTL是10分钟，10分钟的含义是，本地DNS服务器对于域名的缓存时间是10分钟，10分钟之后，本地DNS服务器就会删除这条记录，删除之后，如果有用户访问这个域名，就必须到域名服务器/运营商DNS缓存上去查找了。这里如果网站地址比较稳定可以尽量将此值设置大一些，好处就是长时间的缓存会加快用户访问速度，当然由此有可能带来的一些问题，还需要自己考虑下。

* DNS负载均衡

DNS负载均衡技术的实现原理是在DNS服务器中为同一个主机名配置多个IP地址，在应答DNS查询时，DNS服务器对每个查询将以DNS文件中主机记录的IP地址按顺序返回不同的解析结果，将客户端的访问引导到不同的机器上去，使得不同的客户端访问不同的服务器，从而达到负载均衡的目的。

* httpDns

域名解析过程受限于基于UDP的DNS协议和黑心运营商的限制，容易遭受到域名劫持、调度精度不准和生效时间较长的困扰。httpDNS就是通过http协议代替upd，域名解析请求直接发送到服务提供商的httpdns服务器上，从而绕过运营商的localdns，避免以上问题。参考[DNS原理及其解析过程【精彩剖析】](https://help.aliyun.com/document_detail/52679.html?spm=5176.7947101.245810.1.118b6f846k88HK)

## 参考资料 

* [DNS原理及其解析过程【精彩剖析】](https://blog.51cto.com/369369/812889)
* [一张图看懂DNS域名解析全过程](http://www.maixj.net/ict/dns-chaxun-9208)
* [DNS百度百科](https://baike.baidu.com/item/DNS/427444)
